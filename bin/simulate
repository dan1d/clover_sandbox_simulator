#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "clover_sandbox_simulator"
require "thor"

module CloverSandboxSimulator
  # Command-line interface for Clover Sandbox Simulator
  class CLI < Thor
    class_option :verbose, type: :boolean, aliases: "-v", desc: "Enable verbose logging"

    desc "setup", "Set up restaurant entities (categories, items, discounts, employees, customers)"
    option :business_type, type: :string, default: "restaurant", desc: "Business type (restaurant, retail, salon)"
    def setup
      configure_logging

      puts "üçΩÔ∏è  Clover Sandbox Simulator - Entity Setup"
      puts "=" * 50

      generator = Generators::EntityGenerator.new(business_type: options[:business_type].to_sym)
      generator.setup_all

      puts "\n‚úÖ Setup complete!"
    end

    desc "generate", "Generate orders for today"
    option :count, type: :numeric, aliases: "-n", desc: "Number of orders to generate"
    option :refund_percentage, type: :numeric, aliases: "-r", default: 5,
           desc: "Percentage of orders to refund (0-100, default 5)"
    def generate
      configure_logging

      puts "üçΩÔ∏è  Clover Sandbox Simulator - Order Generation"
      puts "=" * 50

      generator = Generators::OrderGenerator.new(refund_percentage: options[:refund_percentage])
      count = options[:count]

      orders = generator.generate_today(count: count)

      puts "\n‚úÖ Generated #{orders.size} orders!"
    end

    desc "day", "Generate a realistic full day of restaurant operations"
    option :multiplier, type: :numeric, aliases: "-m", default: 1.0, desc: "Order multiplier (0.5 = slow day, 2.0 = busy day)"
    option :refund_percentage, type: :numeric, aliases: "-r", default: 5,
           desc: "Percentage of orders to refund (0-100, default 5)"
    def day
      configure_logging

      puts "üçΩÔ∏è  Clover Sandbox Simulator - Realistic Restaurant Day"
      puts "=" * 50

      generator = Generators::OrderGenerator.new(refund_percentage: options[:refund_percentage])
      orders = generator.generate_realistic_day(multiplier: options[:multiplier])

      puts "\n‚úÖ Generated #{orders.size} orders!"
    end

    desc "rush", "Generate a lunch or dinner rush"
    option :period, type: :string, aliases: "-p", default: "dinner", desc: "Meal period (breakfast, lunch, happy_hour, dinner, late_night)"
    option :count, type: :numeric, aliases: "-n", default: 15, desc: "Number of orders"
    def rush
      configure_logging

      period = options[:period].to_sym
      count = options[:count]

      puts "üçΩÔ∏è  Clover Sandbox Simulator - #{period.to_s.upcase} Rush"
      puts "=" * 50

      generator = Generators::OrderGenerator.new
      data = generator.send(:fetch_required_data)

      unless data
        puts "‚ùå Failed to fetch data. Run setup first."
        return
      end

      orders = []
      count.times do |i|
        order = generator.send(:create_realistic_order,
          period: period,
          data: data,
          order_num: i + 1,
          total_in_period: count
        )

        if order
          orders << order
          generator.send(:update_stats, order, period)
        end
      end

      generator.send(:print_summary)
      puts "\n‚úÖ Generated #{orders.size} #{period} orders!"
    end

    desc "full", "Run full simulation (setup + generate orders)"
    option :count, type: :numeric, aliases: "-n", desc: "Number of orders to generate"
    option :business_type, type: :string, default: "restaurant", desc: "Business type"
    option :refund_percentage, type: :numeric, aliases: "-r", default: 5,
           desc: "Percentage of orders to refund (0-100, default 5)"
    def full
      configure_logging

      puts "üçΩÔ∏è  Clover Sandbox Simulator - Full Simulation"
      puts "=" * 50

      # Setup entities
      entity_gen = Generators::EntityGenerator.new(business_type: options[:business_type].to_sym)
      entity_gen.setup_all

      puts "\n"

      # Generate orders
      order_gen = Generators::OrderGenerator.new(refund_percentage: options[:refund_percentage])
      orders = order_gen.generate_today(count: options[:count])

      puts "\n‚úÖ Full simulation complete!"
      puts "   Orders generated: #{orders.size}"
    end

    desc "delete", "Delete all entities (use with caution!)"
    option :confirm, type: :boolean, desc: "Confirm deletion"
    def delete
      unless options[:confirm]
        puts "‚ö†Ô∏è  This will delete ALL entities from Clover!"
        puts "   Run with --confirm to proceed."
        return
      end

      configure_logging

      puts "üóëÔ∏è  Deleting all entities..."

      generator = Generators::EntityGenerator.new
      generator.delete_all

      puts "\n‚úÖ All entities deleted!"
    end

    desc "status", "Show current Clover merchant status"
    def status
      configure_logging

      puts "üçΩÔ∏è  Clover Sandbox Simulator - Status"
      puts "=" * 50

      services = Services::Clover::ServicesManager.new

      categories = services.inventory.get_categories
      items = services.inventory.get_items
      tenders = services.tender.get_safe_tenders
      employees = services.employee.get_employees
      customers = services.customer.get_customers
      discounts = services.discount.get_discounts
      refunds = services.refund.fetch_refunds

      puts "Categories:  #{categories.size}"
      puts "Menu Items:  #{items.size}"
      puts "Tenders:     #{tenders.size} (sandbox-safe)"
      puts "Employees:   #{employees.size}"
      puts "Customers:   #{customers.size}"
      puts "Discounts:   #{discounts.size}"
      puts "Refunds:     #{refunds.size}"

      puts "\nüìã Categories:"
      categories.each { |c| puts "   - #{c['name']}" }

      puts "\nüí≥ Safe Tenders (no credit/debit):"
      tenders.each { |t| puts "   - #{t['label']}" }
    end

    desc "refunds", "List all refunds"
    option :limit, type: :numeric, aliases: "-l", desc: "Maximum number of refunds to show"
    def refunds
      configure_logging

      puts "üçΩÔ∏è  Clover Sandbox Simulator - Refunds"
      puts "=" * 50

      services = Services::Clover::ServicesManager.new
      refunds = services.refund.fetch_refunds(limit: options[:limit])

      if refunds.empty?
        puts "No refunds found."
        return
      end

      puts "Found #{refunds.size} refunds:\n\n"

      total_amount = 0
      refunds.each do |refund|
        amount = refund["amount"] || 0
        total_amount += amount
        payment_id = refund.dig("payment", "id") || "N/A"
        created_at = refund["createdTime"] ? Time.at(refund["createdTime"] / 1000).strftime("%Y-%m-%d %H:%M") : "N/A"

        puts "  ID: #{refund['id']}"
        puts "     Amount:     $#{'%.2f' % (amount / 100.0)}"
        puts "     Payment:    #{payment_id}"
        puts "     Created:    #{created_at}"
        puts ""
      end

      puts "-" * 40
      puts "Total refunded: $#{'%.2f' % (total_amount / 100.0)}"
    end

    desc "refund", "Create a refund for a payment"
    option :payment_id, type: :string, aliases: "-p", required: true, desc: "Payment ID to refund"
    option :amount, type: :numeric, aliases: "-a", desc: "Amount in cents (omit for full refund)"
    option :reason, type: :string, aliases: "-r", default: "customer_request",
           desc: "Refund reason (customer_request, quality_issue, wrong_order, duplicate_charge)"
    def refund
      configure_logging

      puts "üçΩÔ∏è  Clover Sandbox Simulator - Create Refund"
      puts "=" * 50

      services = Services::Clover::ServicesManager.new

      if options[:amount]
        puts "Creating partial refund of $#{'%.2f' % (options[:amount] / 100.0)}..."
        result = services.refund.create_partial_refund(
          payment_id: options[:payment_id],
          amount: options[:amount],
          reason: options[:reason]
        )
      else
        puts "Creating full refund..."
        result = services.refund.create_full_refund(
          payment_id: options[:payment_id],
          reason: options[:reason]
        )
      end

      if result && result["id"]
        puts "\n‚úÖ Refund created successfully!"
        puts "   Refund ID: #{result['id']}"
        puts "   Amount:    $#{'%.2f' % ((result['amount'] || 0) / 100.0)}"
      else
        puts "\n‚ùå Failed to create refund."
      end
    end

    desc "version", "Show version"
    def version
      puts "Clover Sandbox Simulator v1.0.0"
    end

    # ============================================
    # Gift Card Commands
    # ============================================

    desc "gift_cards", "List all gift cards and their balances"
    def gift_cards
      configure_logging

      puts "üéÅ Clover Sandbox Simulator - Gift Cards"
      puts "=" * 50

      services = Services::Clover::ServicesManager.new
      cards = services.gift_card.fetch_gift_cards

      if cards.empty?
        puts "No gift cards found."
        puts "\nCreate one with: simulate gift_card_create --amount 5000"
        return
      end

      puts "\n#{'ID'.ljust(20)} #{'Card Number'.ljust(20)} #{'Balance'.rjust(12)} #{'Status'.ljust(10)}"
      puts "-" * 65

      total_balance = 0
      cards.each do |card|
        id = card["id"] || "N/A"
        number = mask_card_number(card["cardNumber"] || "Unknown")
        balance = card["balance"] || 0
        status = card["status"] || "UNKNOWN"

        total_balance += balance if status == "ACTIVE"

        balance_str = "$#{'%.2f' % (balance / 100.0)}"
        puts "#{id.ljust(20)} #{number.ljust(20)} #{balance_str.rjust(12)} #{status.ljust(10)}"
      end

      puts "-" * 65
      puts "Total Active Balance: $#{'%.2f' % (total_balance / 100.0)}"
      puts "\n‚úÖ Found #{cards.size} gift cards"
    end

    desc "gift_card_create", "Create a new gift card"
    option :amount, type: :numeric, aliases: "-a", required: true, desc: "Initial balance in cents (e.g., 5000 for $50)"
    option :card_number, type: :string, aliases: "-n", desc: "Optional 16-digit card number"
    def gift_card_create
      configure_logging

      puts "üéÅ Clover Sandbox Simulator - Create Gift Card"
      puts "=" * 50

      services = Services::Clover::ServicesManager.new

      amount = options[:amount]
      card_number = options[:card_number]

      puts "Creating gift card with balance: $#{'%.2f' % (amount / 100.0)}"

      result = services.gift_card.create_gift_card(
        amount: amount,
        card_number: card_number
      )

      if result && result["id"]
        puts "\n‚úÖ Gift card created successfully!"
        puts "   ID:          #{result['id']}"
        puts "   Card Number: #{mask_card_number(result['cardNumber'])}"
        puts "   Balance:     $#{'%.2f' % ((result['balance'] || amount) / 100.0)}"
        puts "   Status:      #{result['status']}"
      else
        puts "\n‚ùå Failed to create gift card"
      end
    end

    desc "gift_card_balance", "Check gift card balance"
    option :id, type: :string, aliases: "-i", required: true, desc: "Gift card ID"
    def gift_card_balance
      configure_logging

      puts "üéÅ Clover Sandbox Simulator - Gift Card Balance"
      puts "=" * 50

      services = Services::Clover::ServicesManager.new

      card = services.gift_card.get_gift_card(options[:id])

      if card
        puts "\nGift Card Details:"
        puts "   ID:          #{card['id']}"
        puts "   Card Number: #{mask_card_number(card['cardNumber'])}"
        puts "   Balance:     $#{'%.2f' % ((card['balance'] || 0) / 100.0)}"
        puts "   Status:      #{card['status']}"
      else
        puts "\n‚ùå Gift card not found: #{options[:id]}"
      end
    end

    desc "gift_card_reload", "Add balance to a gift card"
    option :id, type: :string, aliases: "-i", required: true, desc: "Gift card ID"
    option :amount, type: :numeric, aliases: "-a", required: true, desc: "Amount to add in cents"
    def gift_card_reload
      configure_logging

      puts "üéÅ Clover Sandbox Simulator - Reload Gift Card"
      puts "=" * 50

      services = Services::Clover::ServicesManager.new

      gc_id = options[:id]
      amount = options[:amount]

      puts "Adding $#{'%.2f' % (amount / 100.0)} to gift card #{gc_id}"

      result = services.gift_card.reload_gift_card(gc_id, amount: amount)

      if result
        puts "\n‚úÖ Gift card reloaded successfully!"
        puts "   New Balance: $#{'%.2f' % ((result['balance'] || 0) / 100.0)}"
      else
        puts "\n‚ùå Failed to reload gift card"
      end
    end

    desc "gift_card_redeem", "Redeem/use balance from a gift card"
    option :id, type: :string, aliases: "-i", required: true, desc: "Gift card ID"
    option :amount, type: :numeric, aliases: "-a", required: true, desc: "Amount to redeem in cents"
    def gift_card_redeem
      configure_logging

      puts "üéÅ Clover Sandbox Simulator - Redeem Gift Card"
      puts "=" * 50

      services = Services::Clover::ServicesManager.new

      gc_id = options[:id]
      amount = options[:amount]

      puts "Redeeming $#{'%.2f' % (amount / 100.0)} from gift card #{gc_id}"

      result = services.gift_card.redeem_gift_card(gc_id, amount: amount)

      if result[:success]
        puts "\n‚úÖ Redemption successful!"
        puts "   Amount Redeemed:   $#{'%.2f' % (result[:amount_redeemed] / 100.0)}"
        puts "   Remaining Balance: $#{'%.2f' % (result[:remaining_balance] / 100.0)}"

        if result[:shortfall] > 0
          puts "   ‚ö†Ô∏è  Shortfall:       $#{'%.2f' % (result[:shortfall] / 100.0)} (insufficient balance)"
        end
      else
        puts "\n‚ùå Redemption failed: #{result[:message]}"
      end
    end

    private

    def mask_card_number(card_number)
      return card_number if card_number.nil? || card_number.length < 8

      "#{card_number[0..3]}********#{card_number[-4..]}"
    end

    def configure_logging
      if options[:verbose]
        CloverSandboxSimulator.configuration.logger.level = Logger::DEBUG
      else
        CloverSandboxSimulator.configuration.logger.level = Logger::INFO
      end
    end

    def print_order_summary(orders)
      return if orders.empty?

      total_revenue = 0
      total_tips = 0
      total_tax = 0

      orders.each do |order|
        next unless order && order["payments"]&.dig("elements")

        order["payments"]["elements"].each do |payment|
          total_revenue += payment["amount"] || 0
          total_tips += payment["tipAmount"] || 0
          total_tax += payment["taxAmount"] || 0
        end
      end

      puts "\nüìä Summary:"
      puts "   Revenue:  $#{total_revenue / 100.0}"
      puts "   Tips:     $#{total_tips / 100.0}"
      puts "   Tax:      $#{total_tax / 100.0}"
      puts "   Total:    $#{(total_revenue + total_tips + total_tax) / 100.0}"
    end
  end
end

CloverSandboxSimulator::CLI.start(ARGV)
